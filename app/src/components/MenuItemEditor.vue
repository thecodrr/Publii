<template>
    <div 
        :key="'menu-item-view-' + id"
        class="options-sidebar-wrapper">
        <div class="options-sidebar">
            <h2>
                <template v-if="menuItemID !== ''">Edit menu item</template>
                <template v-if="menuItemID === ''">Add new menu item</template>
            </h2>

            <span
                class="options-sidebar-close"
                name="sidebar-close"
                @click.prevent="hide()">
                &times;
            </span>

            <label
                :class="{ 'is-invalid': errors.indexOf('label') > -1 }"
                key="menu-item-editor-field-label">
                <span>Label</span>
                <input
                    v-model="label"
                    :spellcheck="$store.state.currentSite.config.spellchecking"
                    @keyup="cleanError('label')"
                    type="text">
            </label>

            <label
                :class="{ 'is-invalid': errors.indexOf('type') > -1 }"
                key="menu-item-editor-field-type">
                <span>Type</span>
                <v-select
                    v-model="type"
                    @click.native="cleanError('type')"
                    :options="linkTypes"
                    :searchable="false"
                    :custom-label="customTypeLabels"
                    :show-labels="false"
                    placeholder="Select item type"></v-select>
            </label>

            <label
                v-if="type === 'internal'"
                :class="{ 'is-invalid': errors.indexOf('internalLink') > -1 }"
                key="menu-item-editor-field-internal">
                <span>Internal link</span>
                <input
                    v-model="internalLink"
                    @keyup="cleanError('internalLink')"
                    spellcheck="false"
                    type="text" />
            </label>

            <label
                v-if="type === 'external'"
                :class="{ 'is-invalid': errors.indexOf('externalLink') > -1 }"
                key="menu-item-editor-field-external">
                <span>External URL</span>
                <input
                    v-model="externalLink"
                    @keyup="cleanError('externalLink')"
                    spellcheck="false"
                    type="text" />
            </label>

            <label
                v-if="type === 'tag'"
                :class="{ 'is-invalid': errors.indexOf('tagPage') > -1 }"
                key="menu-item-editor-field-tag">
                <span>Tag page</span>
                <v-select
                    ref="tagPagesSelect"
                    :options="tagPages"
                    @click.native="cleanError('tagPage')"
                    v-model="tagPage"
                    :custom-label="customTagLabels"
                    :close-on-select="true"
                    :show-labels="false"
                    @select="closeDropdown('tagPagesSelect')"
                    placeholder="Select tag page"></v-select>
            </label>

            <label
                v-if="type === 'author'"
                :class="{ 'is-invalid': errors.indexOf('authorPage') > -1 }"
                key="menu-item-editor-field-author">
                <span>Author page</span>
                <v-select
                    ref="authorPagesSelect"
                    :options="authorPages"
                    @click.native="cleanError('authorPage')"
                    v-model="authorPage"
                    :custom-label="customAuthorsLabels"
                    :close-on-select="true"
                    :show-labels="false"
                    @select="closeDropdown('authorPagesSelect')"
                    placeholder="Select author page"></v-select>
            </label>

            <label
                v-if="type === 'post'"
                :class="{ 'is-invalid': errors.indexOf('postPage') > -1 }"
                key="menu-item-editor-field-post">
                <span>Post page</span>
                <v-select
                    ref="postPagesSelect"
                    :options="postPages"
                    @click.native="cleanError('postPage')"
                    v-model="postPage"
                    :custom-label="customPostLabels"
                    :close-on-select="true"
                    :show-labels="false"
                    @select="closeDropdown('postPagesSelect')"
                    placeholder="Select post page"></v-select>
            </label>

            <label key="menu-item-editor-field-title">
                <span>Link Title attribute</span>
                <input
                    v-model="title"
                    :spellcheck="$store.state.currentSite.config.spellchecking"
                    type="text" />
            </label>

            <label key="menu-item-editor-field-cssclass">
                <span>CSS class</span>
                <input
                    v-model="cssClass"
                    spellcheck="false"
                    type="text" />
            </label>

            <label key="menu-item-editor-field-target">
                <span>Link target:</span>
                <v-select
                    v-model="target"
                    :options="linkTargets"
                    :searchable="false"
                    :custom-label="customTargetLabels"
                    :show-labels="false"
                    placeholder="Select link target"></v-select>
            </label>

            <label key="menu-item-editor-field-rel">
                <span>Link rel attribute:</span>
                <input
                    v-model="rel"
                    spellcheck="false"
                    type="text" />
            </label>

            <div class="options-sidebar-buttons">
                <p-button
                    v-if="menuItemID !== ''"
                    type="primary"
                    @click.native="editMenuItem">
                    Save Changes
                </p-button>

                <p-button
                    v-if="menuItemID === ''"
                    type="primary"
                    @click.native="addMenuItem">
                    Add menu item
                </p-button>

                <p-button
                    @click.native="hide()"
                    type="outline">
                    Cancel
                </p-button>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: 'menu-item-editor',
    data () {
        return {
            isVisible: false,
            id: '',
            menuItemID: '',
            parentID: '',
            menuID: '',
            label: '',
            title: '',
            type: '',
            target: '_self',
            rel: '',
            cssClass: '',
            internalLink: '',
            externalLink: '',
            tagPage: '',
            authorPage: '',
            postPage: '',
            errors: []
        };
    },
    computed: {
        linkTypes () {
            return [ 
                'post', 
                'tag',
                'tags',
                'author', 
                'frontpage', 
                'internal',                 
                'external', 
                'separator' 
            ];
        },
        tagPages () {
            return this.$store.state.currentSite.tags.map(tag => tag.id);
        },
        linkTargets () {
            return [ '_self', '_blank' ];
        },
        authorPages () {
            return this.$store.state.currentSite.authors.map(author => author.username).sort((a, b) => {
                if (a.toLowerCase() < b.toLowerCase()) {
                    return -1;
                }

                if (a.toLowerCase() > b.toLowerCase()) {
                    return 1;
                }

                return 0;
            });
        },
        postPages () {
            return this.$store.state.currentSite.posts.map(post => post.id);
        }
    },
    mounted () {
        this.$bus.$on('show-menu-item-editor', params => {
            this.reset();
            this.menuItemID = params.menuItemID || '';
            this.parentID = params.parentID || '';

            if(params.menuID || params.menuID === 0) {
                this.menuID = params.menuID;
            } else {
                this.menuID = '';
            }

            this.label = params.label || '';
            this.title = params.title || '';
            this.cssClass = params.cssClass || '';
            this.target = params.target || '_self';
            this.rel = params.rel || '';

            setTimeout(() => {
                this.type = params.type || '';
                this.setLinkValue(params.link);
            }, 0);
        });
    },
    methods: {
        customTypeLabels (value) {
            switch (value) {
                case 'post': return 'Post link';
                case 'tag': return 'Tag link';
                case 'tags': return 'Tags list link';
                case 'author': return 'Author link';
                case 'frontpage': return 'Frontpage link';
                case 'internal': return 'Internal link';               
                case 'external': return 'External link';
                case 'separator': return 'Text separator';
            }
        },
        customTagLabels (value) {
            return this.$store.state.currentSite.tags.filter(tag => tag.id === value).map(tag => tag.name)[0];
        },
        customAuthorsLabels (value) {
            return this.$store.state.currentSite.authors.filter(author => author.username === value).map(author => author.name)[0];
        },
        customPostLabels (value) {
            return this.$store.state.currentSite.posts.filter(post => post.id === value).map(post => post.title)[0];
        },
        customTargetLabels (value) {
            switch (value) {
                case '_self': return 'The same window';
                case '_blank': return 'New window';
            }
        },
        closeDropdown (refID) {
            this.$refs[refID].isOpen = false;
        },
        reset () {
            this.menuItemID = Date.now();
            this.parentID = '';
            this.menuID = '';
            this.label = '';
            this.title = '';
            this.type = '';
            this.target = '_self';
            this.rel = '';
            this.cssClass = '';
            this.internalLink = '';
            this.externalLink = '';
            this.tagPage = '';
            this.authorPage = '';
            this.postPage = '';
            this.errors = [];
        },
        hide () {
            this.reset();
            this.$bus.$emit('hide-menu-item-editor');
        },
        validate() {
            this.errors = [];

            if(this.label === '') {
                this.errors.push('label');
            }

            if(!this.type) {
                this.errors.push('type');
            }

            if(this.type === 'post' && !(!!this.postPage)) {
                this.errors.push('postPage');
            }

            if(this.type === 'tag' && !(!!this.tagPage)) {
                this.errors.push('tagPage');
            }

            if(this.type === 'author' && !(!!this.authorPage)) {
                this.errors.push('authorPage');
            }

            if(this.type === 'external' && !(!!this.externalLink)) {
                this.errors.push('externalLink')
            }

            if(this.type === 'internal' && !(!!this.internalLink)) {
                this.errors.push('internalLink');
            }

            if(this.errors.length) {
                this.$bus.$emit('message-display', {
                    message: 'Please fill all required fields',
                    type: 'warning',
                    lifeTime: 3
                });
            }

            return this.errors.length === 0;
        },
        cleanError (field) {
            let pos = this.errors.indexOf(field);

            if (pos !== -1) {
                this.errors.splice(pos, 1);
            }
        },
        addMenuItem () {
            if (!this.validate()) {
                return;
            }

            let menuItem = {
                id: new Date().getTime(),
                label: this.label,
                title: this.title,
                type: this.type,
                target: this.target,
                rel: this.rel,
                link: this.getLinkValue(),
                cssClass: this.cssClass,
                items: []
            };

            console.log('MITEM:', menuItem);

            if(this.parentID === '') {
                this.$store.commit('addNewMenuItem', {
                    menuItem: menuItem,
                    menuID: this.menuID
                });
            } else {
                this.$store.commit('addNewSubmenuItem', {
                    menuItem: menuItem,
                    menuID: this.menuID,
                    parentID: this.parentID
                });
            }

            this.hide();
            this.$bus.$emit('save-new-menu-structure');
        },
        editMenuItem () {
            if (!this.validate()) {
                return;
            }

            let menuItem = {
                id: this.menuItemID,
                label: this.label,
                title: this.title,
                type: this.type,
                target: this.target,
                rel: this.rel,
                link: this.getLinkValue(),
                cssClass: this.cssClass
            };

            this.$store.commit('editMenuItem', {
                menuItem: menuItem,
                menuID: this.menuID
            });

            this.hide();
            this.$bus.$emit('save-new-menu-structure');
        },
        getLinkValue () {
            let type = this.type;

            switch (type) {
                case 'post':      return this.postPage;
                case 'tag':       return this.tagPage;
                case 'tags':      return 'empty';
                case 'author':    return this.authorPage;
                case 'frontpage': return 'empty';
                case 'internal':  return this.internalLink;
                case 'external':  return this.externalLink;
                case 'separator': return '';
            }
        },
        setLinkValue (value) {
            this.internalLink = this.type === 'internal' ? value : '';
            this.externalLink = this.type === 'external' ? value : '';
            this.tagPage = this.type === 'tag' ? value : '';
            this.authorPage = this.type === 'author' ? value : '';
            this.postPage = this.type === 'post' ? value : '';
        }
    },
    beforeDestroy () {
        this.$bus.$off('show-menu-item-editor');
    }
}
</script>

<style lang="scss" scoped>
@import '../scss/variables.scss';
@import '../scss/options-sidebar.scss';

.options-sidebar {
    
    h2 {              
        margin-bottom: 1.2rem;
    }

    &-buttons {
        border: none;
        padding-top: 1.8rem;
    }
}
</style>
